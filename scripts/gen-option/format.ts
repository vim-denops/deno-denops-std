import { Option } from "./types.ts";

const denops = "https://deno.land/x/denops_core@v3.0.2/mod.ts";

const translate: Record<string, string> = {
  "default": "defaultValue",
  "delete": "delete_",
  "eval": "eval_",
  "function": "function_",
};

function defaultValue(type: string): string {
  switch (type) {
    case "string":
      return `""`;
    case "number":
      return `0`;
    case "boolean":
      return `false`;
    default:
      throw new Error(`Unknown type ${type}`);
  }
}

function formatDocs(docs: string): string[] {
  const lines = docs.replaceAll(/\*\//g, "* /").split("\n");
  const leading =
    lines.map((v) => v.match(/^\s*/)![0]).reduce((a, v) =>
      a.length < v.length ? a : v
    ).length;
  const normalizedLines = lines.map((v) => ` * ${v.substring(leading)}`);
  return ["/**", ...normalizedLines, " */"];
}

function formatOption({ name, type, scope, docs }: Option): string[] {
  name = translate[name] ?? name;
  const lines = [
    ...formatDocs(docs),
    `export const ${name} = {`,
    ...formatOptionBody(name, type),
    ...(scope.includes("global") ? formatGlobalOptionBody(name, type) : []),
    ...(scope.includes("local") ? formatLocalOptionBody(name, type) : []),
    `};`,
    "",
  ];
  return lines;
}

function formatOptionBody(name: string, type: string): string[] {
  const lines = [
    `  async get(denops: Denops): Promise<${type}> {`,
    `    return await options.get(denops, "${name}") ?? ${defaultValue(type)};`,
    `  },`,
    `  set(denops: Denops, value: ${type}): Promise<void> {`,
    `    return options.set(denops, "${name}", value);`,
    `  },`,
    `  reset(denops: Denops): Promise<void> {`,
    `    return options.remove(denops, "${name}");`,
    `  },`,
  ];
  return lines;
}

function formatGlobalOptionBody(name: string, type: string): string[] {
  const lines = [
    `  async getGlobal(denops: Denops): Promise<${type}> {`,
    `    return await globalOptions.get(denops, "${name}") ?? ${
      defaultValue(type)
    };`,
    `  },`,
    `  setGlobal(denops: Denops, value: ${type}): Promise<void> {`,
    `    return globalOptions.set(denops, "${name}", value);`,
    `  },`,
    `  resetGlobal(denops: Denops): Promise<void> {`,
    `    return globalOptions.remove(denops, "${name}");`,
    `  },`,
  ];
  return lines;
}

function formatLocalOptionBody(name: string, type: string): string[] {
  const lines = [
    `  async getLocal(denops: Denops): Promise<${type}> {`,
    `    return await localOptions.get(denops, "${name}") ?? ${
      defaultValue(type)
    };`,
    `  },`,
    `  setLocal(denops: Denops, value: ${type}): Promise<void> {`,
    `    return localOptions.set(denops, "${name}", value);`,
    `  },`,
    `  resetLocal(denops: Denops): Promise<void> {`,
    `    return localOptions.remove(denops, "${name}");`,
    `  },`,
  ];
  return lines;
}

export function format(options: Option[], root: string): string[] {
  const variable = `${root}/../variable/mod.ts`;
  const lines = [
    "// NOTE: This file is generated. Do NOT modify it manually.",
    `import type { Denops } from "${denops}";`,
    `import { globalOptions, localOptions, options } from "${variable}";`,
    "",
    ...options.map(formatOption),
  ];
  return lines.flat();
}
